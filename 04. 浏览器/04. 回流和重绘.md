# 回流和重绘



## 1、重排和重绘

说完浏览器引擎的渲染流程，再来看两个重要的概念：重排（Reflow）和重绘（Repaint）。 

渲染树是动态构建的，所以，DOM节点和CSS节点的改动都可能会造成渲染树的重新构建。渲染树的改动就会造成页面的重排或者重绘。

### （1）重排

**读取DOM熟悉的时候也会触发重排**

**当我们的操作引发了 DOM 树中几何尺寸的变化（改变元素的大小、位置、布局方式等），这时渲染树里有改动的节点和它影响的节点都要重新计算。**这个过程就叫做重排，也称为回流。在改动发生时，要重新经历页面渲染的整个流程，所以开销是很大的。 

以下操作都会导致页面重排：

- 页面首次渲染；
- 浏览器窗口大小发生变化；
- 元素的内容发生变化；
- 元素的尺寸或者位置发生变化；
- 元素的字体大小发生变化；
- 激活CSS伪类；
- 查询某些属性或者调用某些方法；
- 添加或者删除可见的DOM元素。

在触发重排时，由于浏览器渲染页面是基于流式布局的，所以当触发回流时，会导致周围的DOM元素重新排列，它的影响范围有两种：

- 全局范围：从根节点开始，对整个渲染树进行重新布局；
- 局部范围：对渲染树的某部分或者一个渲染对象进行重新布局。

### （2）重绘

当对 DOM 的修改导致了样式的变化、但未影响其几何尺寸（比如只是修改颜色、背景色）时，浏览器不需重新计算元素的几何属性、直接为该元素绘制新的样式（会跳过重排环节），这个过程叫做重绘。简单来说，重绘是由对元素绘制属性的修改引发的。 

当我们修改元素绘制属性时，页面布局阶段不会执行，因为并没有引起几何位置的变换，所以就直接进入了绘制阶段，然后执行之后的一系列子阶段。相较于重排操作，重绘省去了布局和分层阶段，所以执行效率会比重排操作要高一些。

**下面这些属性会导致回流：**

- color、background 相关属性：background-color、background-image 等；
- outline 相关属性：outline-color、outline-width 、text-decoration；
- border-radius、visibility、box-shadow。

扩展：[关于outline属性](https://www.w3school.com.cn/cssref/pr_outline.asp)

注意： **当触发重排时，一定会触发重绘，但是重绘不一定会引发重排。**

## 2、如何优化

### CSS

1. 将动画效果应用到`position`属性为`absolute`或`fixed`的元素上，使其脱离文档流。

2. **CSS3 硬件加速（GPU加速）**，尽量使用 CSS3 动画，它可以调用 GPU 执行渲染

   使用transform，opacity，filters，will-change，触发CSS3硬件加速，避免回流重绘

3. 不要使用table布局和css表达式（如calc()）

### JS

1. 不要频繁修改和读取DOM的信息（注意：读取DOM也会触发回流，因为他要保证获取的DOM信息是最新的）

   如果非要做批量修改：
   那么可以先设置display:none,修改过后再让其显示；或者把class或者style样式同意修改完之后再应用到DOM上

### React

避免重复渲染。



